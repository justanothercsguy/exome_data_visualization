<!DOCTYPE html>

<html lang="en-US">
    <head>
        <title>Exome Browser</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
        
        {% load static %}
        <script src="{% static 'visualization/js/chart.js' %}"></script>
        <script src="{% static 'visualization/js/gene.js' %}"></script>
        <script src="{% static 'visualization/js/utils.js' %}"></script>
        <!-- 
            This script below can be turned into a separate JS file later
        -->
        <script type="text/javascript">
            var zoomedOutChartController = null;

            $(window).on("load", function() {
                // remove '&quot;' string and parse json from variant_list_json
                var variants = JSON.parse("{{variant_list_json}}".replace(/&quot;/g,'"'));
                var cdsStart = jsonStringToInt("{{gene.cdsstart}}");
                var cdsEnd = jsonStringToInt("{{gene.cdsend}}");
                var exonStarts = jsonStringArrayToIntArray("{{gene.exonstarts}}");
                var exonEnds = jsonStringArrayToIntArray("{{gene.exonends}}");

                var nonCodingLengthLimit = 200;
                var basePairsOutsideExonLimit = 50; 
                var gene = new Gene(
                    cdsStart, cdsEnd, exonStarts, exonEnds, variants, nonCodingLengthLimit
                );

                gene.limitNonCodingExonLength(nonCodingLengthLimit);
                console.log("gene after nonCodingLengthLimit");
                console.log(gene);

                console.log("gene exon length array");
                console.log(gene.getExonLengths(gene.getExons()));

                console.log("gene sum of exon length array");
                console.log(gene.getSumOfExonLengths(gene.getExons()));
                
                console.log("gene sum of uniform intron length");
                console.log(gene.getUniformIntronLength());

                console.log("gene sum of uniform intron length array");
                console.log(gene.getSumOfUniformIntronLengths());

                console.log("gene exons with uniform intron length");
                console.log(gene.getExonsWithUniformIntronLength());

                console.log("gene exon starts with original intron length");
                console.log(gene.getExonStarts(gene.getExons()));

                console.log("gene exon ends with original intron length");
                console.log(gene.getExonEnds(gene.getExons()));

                console.log("gene exon starts with uniform intron length");
                console.log(gene.getExonStarts(gene.getExonsWithUniformIntronLength()));

                console.log("gene exon ends with uniform intron length");
                console.log(gene.getExonEnds(gene.getExonsWithUniformIntronLength()));

                console.log("gene offset");
                console.log(gene.getOffset());

                console.log("gene exon starts with original intron length minus offset");
                console.log(gene.getIntArrayMinusOffset(
                    gene.getExonStarts(gene.getExons()), gene.getOffset()
                ));

                console.log("gene exon ends with original intron length minus offset");
                console.log(gene.getIntArrayMinusOffset(
                    gene.getExonEnds(gene.getExons()), gene.getOffset()
                ));

                console.log("gene exon starts with uniform intron length minus offset");
                console.log(gene.getIntArrayMinusOffset(
                    gene.getExonStarts(gene.getExonsWithUniformIntronLength()), gene.getOffset()
                ));

                console.log("gene exon ends with uniform intron length minus offset");
                console.log(gene.getIntArrayMinusOffset(
                    gene.getExonEnds(gene.getExonsWithUniformIntronLength()), gene.getOffset()
                ));

                console.log("gene introns");
                console.log(gene.getIntrons());

                console.log("gene intron lengths");
                console.log(gene.getIntronLengths());

                console.log("gene indices of introns with length greater than threshold");
                console.log(gene.getSplitIntronIndices(basePairsOutsideExonLimit));

                console.log("gene domain - base pair positions with original intron lengths");
                console.log(gene.getDomain(basePairsOutsideExonLimit));
                
                console.log("gene range - base pair positions with uniform intron length minus offset");
                console.log(gene.getRange(basePairsOutsideExonLimit));
                
                var chartMargin = {top: 30, right: 30, bottom: 50, left: 120};
                var chartDimension = {width: 1200, height: 320};
                var yAxisVariableString = "MAF";
                var exonBar = {nonCodingHeight: 10, codingHeight: 20, color: "#868686"};
                var variantLollipop = {width: 0.2, radius: 3};
   
                zoomedOutChartController = new ChartController(
                    chartMargin, chartDimension, yAxisVariableString, 
                    exonBar, variantLollipop, gene
                );
                
                console.log("zoomedOutChartController");
                console.log(zoomedOutChartController);

                // initialize svg object and transforms for zoomed out chart
                var svgZoomedOut = zoomedOutChartController.addSvgToDiv(".chart-zoomed-out");
                var exonTransformZoomedOut = zoomedOutChartController.addTransformToSvg(
                    svgZoomedOut, zoomedOutChartController.chartMargin.left, 
                    zoomedOutChartController.chartMargin.top
                );
                var yGapBetweenExonsAndVariants = 5;
                var variantTransformZoomedOut = zoomedOutChartController.addTransformToSvg(
                    svgZoomedOut, zoomedOutChartController.chartMargin.left, 
                    (zoomedOutChartController.chartMargin.top 
                        + zoomedOutChartController.exonBar.codingHeight 
                        + yGapBetweenExonsAndVariants)
                );

                var scaleUniformIntronsToChart 
                    = zoomedOutChartController.getScaleUniformIntronsToChart();
                var scaleOriginalIntronsToUniformIntrons 
                    = gene.getScaleOriginalIntronsToUniformIntrons();
                var exonBars = zoomedOutChartController.addRectToTransform(exonTransformZoomedOut);
                var intronLines = zoomedOutChartController.addLinesToTransform(exonTransformZoomedOut);
                
                console.log("gene non coding exon partitions")
                console.log(gene.getNonCodingExonPartitions());

                console.log("gene non coding exon partition lengths")
                console.log(gene.getExonLengths(gene.getNonCodingExonPartitions()));

                var nonCodingExonBars = 
                    zoomedOutChartController.addNonCodingExonPartitionsToTransform(exonTransformZoomedOut);
                
                gene.initializeVariants(variants);
                console.log("gene variants after initializeVariants()");
                console.log(gene.getVariants());

                console.log("gene variant map");
                console.log(gene.getVariantMap());

                console.log("chart add variants to transform map");
                zoomedOutChartController.addVariantsToTransform(variantTransformZoomedOut);

            });
        </script>
    </head>
    <body>
        <h3>Gene: {{ gene }}</h3>
        <div class="y-axis-button-container">
            <button type="button" class="MAF" value="MAF" onclick="changeYAxisVariable('MAF')">MAF</button>
            <button type="button" class="alleleNumber" value="alleleNumber" onclick="changeYAxisVariable('alleleNumber')">alleleNumber</button>
        </div>
        <div class="chart-zoomed-out"></div>
        <div class="chart-zoomed-in"></div>
    </body>
</html>